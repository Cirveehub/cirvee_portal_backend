npm warn Unknown user config "fetch-retry-mintime". This will stop working in the next major version of npm.
npm warn Unknown user config "fetch-retry-maxtime". This will stop working in the next major version of npm.

> portal_backend@1.0.0 test
> dotenv -e .env.test -- jest --runInBand --detectOpenHandles src/tests/queue.test.ts

  console.log
    [dotenv@17.2.3] injecting env (0) from .env.test -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

      at _log (node_modules/dotenv/lib/main.js:142:11)

2025-12-30 09:01:51 [32minfo[39m: Redis connected 
2025-12-30 09:01:51 [32minfo[39m: Redis is ready to accept commands
  console.log
    Job added: 1

      at Object.<anonymous> (src/tests/queue.test.ts:34:17)

  console.error
    Error: Unhandled error. (Error: connect ETIMEDOUT
        at Socket.<anonymous> (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\Redis.js:171:41)
        at Object.onceWrapper (node:events:638:28)
        at Socket.emit (node:events:524:28)
        at Socket._onTimeout (node:net:595:8)
        at listOnTimeout (node:internal/timers:581:17)
        at processTimers (node:internal/timers:519:7) {
      errorno: 'ETIMEDOUT',
      code: 'ETIMEDOUT',
      syscall: 'connect'
    })
        at Worker.emit (node:events:513:17)
        at Worker.emit (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\bullmq\src\classes\queue-base.ts:123:20)
        at Worker.emit (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\bullmq\src\classes\worker.ts:401:18)
        at RedisConnection.<anonymous> (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\bullmq\src\classes\worker.ts:351:55)
        at RedisConnection.emit (node:events:524:28)
        at EventEmitter.RedisConnection.handleClientError (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\bullmq\src\classes\redis-connection.ts:121:12)
        at EventEmitter.emit (node:events:524:28)
        at EventEmitter.silentEmit (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\Redis.js:484:30)
        at C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\redis\event_handler.js:221:14
        at Socket.<anonymous> (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\Redis.js:178:61)
        at Object.onceWrapper (node:events:638:28)
        at Socket.emit (node:events:524:28)
        at Socket._onTimeout (node:net:595:8)
        at listOnTimeout (node:internal/timers:581:17)
        at processTimers (node:internal/timers:519:7) {
      code: 'ERR_UNHANDLED_ERROR',
      context: Error: connect ETIMEDOUT
          at Socket.<anonymous> (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\Redis.js:171:41)
          at Object.onceWrapper (node:events:638:28)
          at Socket.emit (node:events:524:28)
          at Socket._onTimeout (node:net:595:8)
          at listOnTimeout (node:internal/timers:581:17)
          at processTimers (node:internal/timers:519:7) {
        errorno: 'ETIMEDOUT',
        code: 'ETIMEDOUT',
        syscall: 'connect'
      }
    }

      at Worker.emit (node_modules/bullmq/src/classes/queue-base.ts:129:17)
      at Worker.emit (node_modules/bullmq/src/classes/worker.ts:401:18)
      at RedisConnection.<anonymous> (node_modules/bullmq/src/classes/worker.ts:351:55)
      at EventEmitter.RedisConnection.handleClientError (node_modules/bullmq/src/classes/redis-connection.ts:121:12)
      at EventEmitter.silentEmit (node_modules/ioredis/built/Redis.js:484:30)
      at node_modules/ioredis/built/redis/event_handler.js:221:14
      at Socket.<anonymous> (node_modules/ioredis/built/Redis.js:178:61)

  console.error
    Error: Unhandled error. (Error: connect ETIMEDOUT
        at Socket.<anonymous> (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\Redis.js:171:41)
        at Object.onceWrapper (node:events:638:28)
        at Socket.emit (node:events:524:28)
        at Socket._onTimeout (node:net:595:8)
        at listOnTimeout (node:internal/timers:581:17)
        at processTimers (node:internal/timers:519:7) {
      errorno: 'ETIMEDOUT',
      code: 'ETIMEDOUT',
      syscall: 'connect'
    })
        at Worker.emit (node:events:513:17)
        at Worker.emit (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\bullmq\src\classes\queue-base.ts:123:20)
        at Worker.emit (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\bullmq\src\classes\worker.ts:401:18)
        at RedisConnection.<anonymous> (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\bullmq\src\classes\worker.ts:351:55)
        at RedisConnection.emit (node:events:524:28)
        at EventEmitter.RedisConnection.handleClientError (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\bullmq\src\classes\redis-connection.ts:121:12)
        at EventEmitter.emit (node:events:524:28)
        at EventEmitter.silentEmit (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\Redis.js:484:30)
        at C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\redis\event_handler.js:221:14
        at Socket.<anonymous> (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\Redis.js:178:61)
        at Object.onceWrapper (node:events:638:28)
        at Socket.emit (node:events:524:28)
        at Socket._onTimeout (node:net:595:8)
        at listOnTimeout (node:internal/timers:581:17)
        at processTimers (node:internal/timers:519:7) {
      code: 'ERR_UNHANDLED_ERROR',
      context: Error: connect ETIMEDOUT
          at Socket.<anonymous> (C:\Users\user\Desktop\cirvee\portal_backend\node_modules\ioredis\built\Redis.js:171:41)
          at Object.onceWrapper (node:events:638:28)
          at Socket.emit (node:events:524:28)
          at Socket._onTimeout (node:net:595:8)
          at listOnTimeout (node:internal/timers:581:17)
          at processTimers (node:internal/timers:519:7) {
        errorno: 'ETIMEDOUT',
        code: 'ETIMEDOUT',
        syscall: 'connect'
      }
    }

      at Worker.emit (node_modules/bullmq/src/classes/queue-base.ts:129:17)
      at Worker.emit (node_modules/bullmq/src/classes/worker.ts:401:18)
      at RedisConnection.<anonymous> (node_modules/bullmq/src/classes/worker.ts:351:55)
      at EventEmitter.RedisConnection.handleClientError (node_modules/bullmq/src/classes/redis-connection.ts:121:12)
      at EventEmitter.silentEmit (node_modules/ioredis/built/Redis.js:484:30)
      at node_modules/ioredis/built/redis/event_handler.js:221:14
      at Socket.<anonymous> (node_modules/ioredis/built/Redis.js:178:61)

2025-12-30 09:02:33 [31merror[39m: Redis connection error: read ECONNRESET
  console.error
    Error: read ECONNRESET
        at TCP.onStreamRead (node:internal/stream_base_commons:218:20)
        at TCP.callbackTrampoline (node:internal/async_hooks:130:17) {
      errno: -4077,
      code: 'ECONNRESET',
      syscall: 'read'
    }

      at Queue.emit (node_modules/bullmq/src/classes/queue-base.ts:129:17)
      at Queue.emit (node_modules/bullmq/src/classes/queue.ts:192:18)
      at RedisConnection.<anonymous> (node_modules/bullmq/src/classes/queue-base.ts:75:56)
      at EventEmitter.RedisConnection.handleClientError (node_modules/bullmq/src/classes/redis-connection.ts:121:12)
      at EventEmitter.silentEmit (node_modules/ioredis/built/Redis.js:484:30)
      at Socket.<anonymous> (node_modules/ioredis/built/redis/event_handler.js:221:14)

2025-12-30 09:02:33 [33mwarn[39m:  Redis connection closed
FAIL src/tests/queue.test.ts (54.997 s)
  Email Queue Integration
    â”œÃ¹ should process email jobs (10291 ms)
    â”œÃ¹ should process assignment creation emails (10271 ms)
    â”œÃ¹ should process announcement emails (20013 ms)

  Î“Ã¹Ã… Email Queue Integration Î“Ã‡â•‘ should process email jobs

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "test@queue.com", "Queue Test", "123456"

    Number of calls: 0

      36 |         await new Promise(resolve => setTimeout(resolve, 10000));
      37 |
    > 38 |         expect(sendSpy).toHaveBeenCalledWith(payload.email, payload.name, payload.otp);
         |                         ^
      39 |     }, 20000);
      40 |
      41 |     it("should process assignment creation emails", async () => {

      at Object.<anonymous> (src/tests/queue.test.ts:38:25)

  Î“Ã¹Ã… Email Queue Integration Î“Ã‡â•‘ should process assignment creation emails

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "student@test.com", "Student", "Test Assignment", "Test Course", Any<String>

    Number of calls: 0

      57 |         await new Promise(resolve => setTimeout(resolve, 10000));
      58 |
    > 59 |         expect(sendSpy).toHaveBeenCalledWith(
         |                         ^
      60 |             payload.email, 
      61 |             payload.studentName, 
      62 |             payload.assignmentTitle, 

      at Object.<anonymous> (src/tests/queue.test.ts:59:25)

  Î“Ã¹Ã… Email Queue Integration Î“Ã‡â•‘ should process announcement emails

    thrown: "Exceeded timeout of 20000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      66 |     }, 20000);
      67 |
    > 68 |     it("should process announcement emails", async () => {
         |       ^
      69 |         const payload = {
      70 |             email: "student@test.com",
      71 |             name: "Student",

      at src/tests/queue.test.ts:68:7
      at Object.<anonymous> (src/tests/queue.test.ts:8:9)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 3 total
Snapshots:   0 total
Time:        55.88 s
Ran all test suites matching src/tests/queue.test.ts.
2025-12-30 09:02:43 [31merror[39m: Redis connection error: connect ETIMEDOUT
2025-12-30 09:02:43 [33mwarn[39m:  Redis connection closed
2025-12-30 09:02:52 [32minfo[39m: Redis connected 
2025-12-30 09:02:52 [32minfo[39m: Redis is ready to accept commands
  console.error
    [ioredis] Unhandled error event:

      at EventEmitter.silentEmit (node_modules/ioredis/built/Redis.js:487:21)
      at node_modules/ioredis/built/redis/event_handler.js:221:14
      at Socket.<anonymous> (node_modules/ioredis/built/Redis.js:178:61)

(node:31196) [JEST-01] DeprecationWarning: 'matchers' property was accessed on [Object] after it was soft deleted
  Jest deletes objects that were set on the global scope between test files to reduce memory leaks.
  Currently it only "soft" deletes them and emits this warning if those objects were accessed after their deletion.
  In future versions of Jest, this behavior will change to "on", which will likely fail tests.
  You can change the behavior in your test configuration now to reduce memory usage.
(Use `node --trace-deprecation ...` to show where the warning was created)
